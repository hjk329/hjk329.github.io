---
title:  "Next.js의 Preview Mode"
categories: 
  - Next.js
tags:
  - Preview Mode
  - API Routes
  - F-Lab
  - 에프랩
  - 짱프랩
  - flab
  - 블로그 해커톤
toc: true
toc_sticky: true
toc_label: "Preview Mode 👀"
share: true
published: false

---

3월 11일 <a href='https://f-lab.kr' target='_blank'>F-Lab</a> 블로그 해커톤에 참여하여 작성한 글입니다 :)

## Preview Mode란?
일반적으로 Headless CMS에서 SSG를 사용하는 것이 유리하다.  
빌드 타임에 데이터 패칭을 하기 때문에 콘텐츠별로 안정적인 View를 제공할 수 있기 때문이다.  
그러나, SSG를 사용한다면 작성한 글이나 글을 수정한 내용이 즉시 반영된 모습을 확인하기 어렵다. SSG는 빌드 타임에 데이터 패칭이 발생하기 때문이다.  
즉, 데이터 패칭이 발생했던 빌드 타임 이후에 생성 및 수정된 글은 변경 사항을 즉각적으로 확인할 수 없다.  

**Next.js는 사용자가 요청할 때마다 드래프트를 미리볼 수 있도록 하기 위해 `Preview Mode`라는 기능을 제공한다.**

### 참고: Headless CMS
> CMS란?
Content Management System의 약자로 콘텐츠를 관리하기 위한 시스템을 말한다.  
콘텐츠의 대상은 블로그가 될 수도 있고, 공지사항이 될 수도 있고, Q&A 게시판 등 다양하다.  
CMS는 이러한 다양한 콘텐츠를 관리하고, 사용자에게 보여주기 위해 사용된다.  

> Headless CMS란?
기존의 결합형 CMS는 백엔드와 프론트엔드가 긴밀하게 연결되어 웹 사이트를 구성한다.  
콘텐츠를 발행하면 데이터베이스에 저장되고, 정해진 특정 템플릿에 따라서 웹사이트에 발행한다.  
콘텐츠에 따른 서식을 완전히 제어할 수는 있겠지만 다양한 환경의 어플리케이션에서 보여져야하는 측면에서는 유연성이 떨어질 수 있다.  

반면에 Headless CMS는 콘텐츠 저장소인 백엔드와 웹 사이트의 표현 부분인 프론트엔드를 분리한다.  
백엔드는 콘텐츠를 생성하거나, 저장 및 관리하고 해당 콘텐츠는 주로 JSON 형태로 `API`를 통해 전달된다.  
프론트엔드는 `API`를 통해 수신한 정보를 렌더링만 하면 된다. 


즉, 백엔드에서 전달받은 콘텐츠(JSON)은 디자인이나 레이아웃 정보를 포함하지 않은, 순수한 콘텐츠이다.  
해당 콘텐츠를 어떻게 보여줄지에 대해서는 프론트엔드에서 관리한다.  
따라서, 데스크톱이나 모바일 디바이스 등 다양한 매체의 특성에 따라 콘텐츠를 보여줄 수 있다. 
이처럼 Headless CMS는 콘텐츠의 관리와 배포가 서로 독립적이라는 것에 의의가 있다.  

<a href='https://www.storyblok.com/tp/headless-cms-explained' target='_blank'>Headless CMS 관련 더 자세한 설명은 이 링크를 참고해주세요</a>

## Preview Mode API

### 기본 사용법
Preview Mode를 사용하기 위해서는 API Routes의 핸들러의 response 객체의 `setPreviewData` 메소드를 사용한다.  
`setPreviewData` 로 전달되는 인자는 객체여야 한다.  

`res.setPreviewData` 은 브라우저에 `__prerender_bypass`, `__next_preview_data` 라는 이름으로 쿠키를 셋팅하는데 해당 쿠키를 통해 Preview Mode를 사용할 수 있게 된다.  
Next.js를 통해 들어오는 어떤 요청이든 해당 쿠키를 가지고 있다면 Preview Mode로 인식되기 때문이다.  

공식 문서에 나온 예제처럼 코드를 작성해보았다.  

```
pages/api/preview.js

export default function handler(req, res) {
  res.setPreviewData({})
  res.end('Preview mode enabled')
}
```

클라이언트 사이드에서 위 주소의 API를 호출하자 `__prerender_bypass`, `__next_preview_data` 라는 이름의 쿠키가 생성된 것을 확인할 수 있었다.  

![image](https://user-images.githubusercontent.com/84058944/223419402-e51e6669-98c9-45e5-ad21-3e7958a6ec58.png)  


위 API를 호출하자 `__prerender_bypass`, `__next_preview_data` 라는 이름의 쿠키가 생성된 것을 확인할 수 있었다.  


### 빌드 타임에 패칭한 데이터를 업데이트 해보자!
